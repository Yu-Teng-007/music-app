# 🏗️ 后端模块架构文档

**版本**: v2.0  
**更新日期**: 2025-06-27  
**重构状态**: ✅ 已完成

---

## 📋 重构概述

本次重构旨在优化后端项目的模块结构，提高代码的可维护性和可扩展性。重构遵循NestJS最佳实践，采用领域驱动设计(DDD)的思想，将相关功能合理归类。

### 🎯 重构目标

1. **模块化设计**: 将相关功能归类到同一模块下
2. **职责分离**: 明确各模块的职责边界
3. **依赖管理**: 优化模块间的依赖关系
4. **可维护性**: 提高代码的可读性和维护性
5. **可扩展性**: 为未来功能扩展提供良好的架构基础

---

## 🔄 重构前后对比

### 重构前的问题

- ❌ 用户相关功能分散（`user-preferences` 独立存在）
- ❌ 媒体功能分离（`upload` 和 `download` 分开）
- ❌ 缺少用户管理模块
- ❌ 模块职责不够清晰
- ❌ 部分功能归类不合理

### 重构后的改进

- ✅ 创建统一的用户管理模块
- ✅ 合并媒体处理相关功能
- ✅ 明确模块职责边界
- ✅ 优化依赖关系
- ✅ 符合NestJS最佳实践

---

## 📁 新模块架构

### 1. 认证授权模块 (`src/auth/`)

**职责**: 用户身份认证和授权管理

```
auth/
├── guards/                 # 路由守卫
│   ├── jwt-auth.guard.ts
│   ├── local-auth.guard.ts
│   └── roles.guard.ts
├── strategies/             # 认证策略
│   ├── jwt.strategy.ts
│   └── local.strategy.ts
├── decorators/             # 装饰器
│   ├── current-user.decorator.ts
│   └── roles.decorator.ts
├── auth.controller.ts      # 认证控制器
├── auth.service.ts         # 认证服务
└── auth.module.ts          # 认证模块
```

**核心功能**:
- JWT令牌管理
- 用户登录/注册
- 密码重置
- 权限验证

### 2. 用户管理模块 (`src/users/`) ✨

**职责**: 用户信息和偏好管理

```
users/
├── preferences/            # 用户偏好子模块
│   ├── user-preferences.controller.ts
│   ├── user-preferences.service.ts
│   └── user-preferences.module.ts
├── users.controller.ts     # 用户控制器 (计划添加)
├── users.service.ts        # 用户服务 (计划添加)
└── users.module.ts         # 用户模块
```

**核心功能**:
- 用户档案管理
- 偏好设置
- 隐私控制
- 账户安全

### 3. 媒体处理模块 (`src/media/`) ✨

**职责**: 文件上传下载和媒体处理

```
media/
├── upload/                 # 文件上传子模块
│   ├── upload.controller.ts
│   ├── upload.service.ts
│   └── upload.module.ts
├── download/               # 文件下载子模块
│   ├── download.controller.ts
│   ├── download.service.ts
│   ├── download.module.ts
│   └── README.md
└── media.module.ts         # 媒体模块
```

**核心功能**:
- 文件上传处理
- 音乐下载管理
- 格式转换
- 存储管理

### 4. 音乐数据模块 (`src/songs/`)

**职责**: 歌曲信息和元数据管理

```
songs/
├── songs.controller.ts     # 歌曲控制器
├── songs.service.ts        # 歌曲服务
└── songs.module.ts         # 歌曲模块
```

**核心功能**:
- 歌曲CRUD操作
- 歌曲搜索
- 元数据管理
- 播放统计

### 5. 其他业务模块

| 模块 | 路径 | 职责 |
|------|------|------|
| 歌单管理 | `src/playlists/` | 歌单创建、编辑、分享 |
| 收藏管理 | `src/favorites/` | 收藏歌曲、歌单管理 |
| 音乐分类 | `src/genres/` | 音乐类型分类管理 |
| 播放历史 | `src/history/` | 用户播放记录 |
| 搜索历史 | `src/search-history/` | 搜索记录管理 |
| 社交功能 | `src/social/` | 用户关注、动态分享 |
| 评论系统 | `src/comments/` | 评论、回复、点赞 |
| 实时通信 | `src/realtime/` | WebSocket消息推送 |
| 短信服务 | `src/sms/` | 验证码发送 |

---

## 🔗 模块依赖关系

### 依赖层级

```
Level 1: 基础设施层
├── common/                 # 公共模块
├── config/                 # 配置管理
├── database/               # 数据库连接
└── entities/               # 数据实体

Level 2: 核心服务层
├── auth/                   # 认证服务
└── sms/                    # 短信服务

Level 3: 业务逻辑层
├── users/                  # 用户管理
├── media/                  # 媒体处理
├── songs/                  # 歌曲管理
├── playlists/              # 歌单管理
├── favorites/              # 收藏管理
├── genres/                 # 分类管理
├── history/                # 历史记录
└── search-history/         # 搜索历史

Level 4: 应用服务层
├── social/                 # 社交功能
├── comments/               # 评论系统
└── realtime/               # 实时通信
```

### 依赖规则

1. **向上依赖**: 高层模块可以依赖低层模块
2. **同层隔离**: 同层模块之间避免直接依赖
3. **接口抽象**: 通过接口定义模块间的交互
4. **循环依赖**: 严格避免循环依赖

---

## 🚀 重构实施过程

### 第一阶段: 模块重组 ✅

1. **创建用户模块**
   - 重命名 `user-preferences` → `users`
   - 将用户偏好作为子模块
   - 更新引用路径

2. **创建媒体模块**
   - 创建 `media` 目录
   - 移动 `upload` 和 `download` 模块
   - 创建统一的 `MediaModule`

3. **更新模块引用**
   - 修复 import 路径
   - 更新 `app.module.ts`
   - 验证模块加载

### 第二阶段: 文档更新 ✅

1. **API文档更新**
   - 添加模块结构说明
   - 更新API分类
   - 补充新模块接口

2. **架构文档创建**
   - 编写模块架构文档
   - 说明重构原因和目标
   - 提供最佳实践指导

### 第三阶段: 测试验证 ✅

1. **编译测试**
   - 验证TypeScript编译
   - 检查依赖关系
   - 确保无语法错误

2. **功能测试**
   - 验证服务启动
   - 测试API接口
   - 确保功能完整

---

## 📝 最佳实践建议

### 1. 模块设计原则

- **单一职责**: 每个模块只负责一个业务领域
- **高内聚**: 模块内部功能紧密相关
- **低耦合**: 模块间依赖关系简单清晰
- **可测试**: 模块设计便于单元测试

### 2. 文件组织规范

- **控制器**: 处理HTTP请求和响应
- **服务**: 实现业务逻辑
- **模块**: 组织和配置依赖注入
- **DTO**: 定义数据传输对象
- **实体**: 定义数据库实体

### 3. 命名约定

- **文件名**: 使用kebab-case命名
- **类名**: 使用PascalCase命名
- **方法名**: 使用camelCase命名
- **常量**: 使用UPPER_SNAKE_CASE命名

### 4. 依赖注入

- **构造函数注入**: 优先使用构造函数注入
- **接口抽象**: 依赖接口而非具体实现
- **作用域管理**: 合理设置服务的作用域
- **循环依赖**: 避免模块间的循环依赖

---

## 🔮 未来规划

### 短期目标 (1-2个月)

- [ ] 完善用户模块功能
- [ ] 优化媒体处理性能
- [ ] 添加更多单元测试
- [ ] 完善错误处理机制

### 中期目标 (3-6个月)

- [ ] 实现微服务架构
- [ ] 添加缓存层优化
- [ ] 实现API版本管理
- [ ] 添加性能监控

### 长期目标 (6-12个月)

- [ ] 支持多租户架构
- [ ] 实现分布式部署
- [ ] 添加AI推荐功能
- [ ] 完善数据分析平台

---

## 📞 联系方式

如有关于模块架构的问题或建议，请联系开发团队：

- **技术负责人**: [技术负责人邮箱]
- **架构师**: [架构师邮箱]
- **开发团队**: [团队邮箱]

---

*本文档将随着项目发展持续更新，请关注最新版本。*
