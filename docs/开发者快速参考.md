# 🚀 开发者快速参考

**版本**: v2.0  
**更新日期**: 2025-06-27  
**适用于**: 后端模块重构后

---

## 📁 新模块结构速查

### 🏗️ 核心模块

| 模块 | 路径 | API前缀 | 主要功能 |
|------|------|---------|----------|
| 认证授权 | `src/auth/` | `/auth` | 登录、注册、JWT管理 |
| 用户管理 | `src/users/` | `/users` | 用户档案、偏好设置 |
| 媒体处理 | `src/media/` | `/upload`, `/download` | 文件上传下载 |
| 歌曲数据 | `src/songs/` | `/songs` | 歌曲信息管理 |
| 歌单管理 | `src/playlists/` | `/playlists` | 歌单CRUD操作 |

### 🔧 业务模块

| 模块 | 路径 | API前缀 | 主要功能 |
|------|------|---------|----------|
| 收藏管理 | `src/favorites/` | `/favorites` | 收藏歌曲、歌单 |
| 分类管理 | `src/genres/` | `/genres` | 音乐类型分类 |
| 播放历史 | `src/history/` | `/history` | 播放记录 |
| 搜索历史 | `src/search-history/` | `/search-history` | 搜索记录 |
| 社交功能 | `src/social/` | `/social` | 关注、动态 |
| 评论系统 | `src/comments/` | `/comments` | 评论、回复 |
| 实时通信 | `src/realtime/` | `/realtime` | WebSocket |
| 短信服务 | `src/sms/` | `/sms` | 验证码发送 |

---

## 🔗 常用导入路径

### 实体 (Entities)
```typescript
import { User } from '../entities/user.entity'
import { Song } from '../entities/song.entity'
import { Playlist } from '../entities/playlist.entity'
import { UserPreference } from '../entities/user-preference.entity'
```

### DTO (数据传输对象)
```typescript
import { CreateSongDto, UpdateSongDto } from '../dto/song.dto'
import { CreatePlaylistDto } from '../dto/playlist.dto'
import { UpsertPreferenceDto } from '../dto/user-preferences.dto'
```

### 服务 (Services)
```typescript
// 认证服务
import { AuthService } from '../auth/auth.service'

// 用户偏好服务
import { UserPreferencesService } from '../users/preferences/user-preferences.service'

// 媒体服务
import { UploadService } from '../media/upload/upload.service'
import { DownloadService } from '../media/download/download.service'

// 业务服务
import { SongsService } from '../songs/songs.service'
import { PlaylistsService } from '../playlists/playlists.service'
```

### 守卫 (Guards)
```typescript
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard'
import { LocalAuthGuard } from '../auth/guards/local-auth.guard'
import { RolesGuard } from '../auth/guards/roles.guard'
```

---

## 🛠️ 开发工作流

### 1. 创建新功能模块

```bash
# 1. 创建模块目录
mkdir src/new-module

# 2. 生成模块文件
nest g module new-module
nest g controller new-module
nest g service new-module

# 3. 更新 app.module.ts
# 添加新模块到 imports 数组
```

### 2. 添加新API接口

```typescript
// 1. 定义DTO
// src/dto/new-feature.dto.ts
export class CreateFeatureDto {
  @IsString()
  name: string
}

// 2. 实现服务方法
// src/new-module/new-module.service.ts
async createFeature(dto: CreateFeatureDto) {
  // 业务逻辑
}

// 3. 添加控制器方法
// src/new-module/new-module.controller.ts
@Post()
@ApiOperation({ summary: '创建功能' })
async create(@Body() dto: CreateFeatureDto) {
  return this.service.createFeature(dto)
}
```

### 3. 数据库操作

```typescript
// 1. 注入Repository
constructor(
  @InjectRepository(Entity)
  private readonly repository: Repository<Entity>
) {}

// 2. 常用操作
const entity = await this.repository.findOne({ where: { id } })
const entities = await this.repository.find()
const newEntity = await this.repository.save(dto)
await this.repository.delete(id)
```

---

## 🔍 调试和测试

### 启动开发服务器
```bash
cd music-app-backend
npm run start:dev
```

### API文档访问
- **Swagger UI**: http://localhost:3000/api/docs
- **API基础URL**: http://localhost:3000/api

### 常用测试命令
```bash
# 运行所有测试
npm run test

# 运行特定模块测试
npm run test -- --testPathPattern=auth

# 生成测试覆盖率报告
npm run test:cov
```

### 数据库操作
```bash
# 生成迁移文件
npm run migration:generate -- -n MigrationName

# 运行迁移
npm run migration:run

# 回滚迁移
npm run migration:revert
```

---

## 🔧 配置文件

### 环境变量 (.env)
```bash
# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=password
DB_DATABASE=music_app

# JWT配置
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379

# 文件上传配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760
```

### TypeORM配置
```typescript
// src/config/database.config.ts
export const databaseConfig = {
  type: 'postgres',
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT),
  username: process.env.DB_USERNAME,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_DATABASE,
  entities: [__dirname + '/../**/*.entity{.ts,.js}'],
  synchronize: process.env.NODE_ENV === 'development',
}
```

---

## 🚨 常见问题解决

### 1. 模块导入错误
```typescript
// ❌ 错误的导入路径
import { Service } from './old-path/service'

// ✅ 正确的导入路径
import { Service } from '../new-module/service'
```

### 2. 循环依赖问题
```typescript
// ❌ 避免循环依赖
// module-a imports module-b
// module-b imports module-a

// ✅ 使用forwardRef解决
@Inject(forwardRef(() => ServiceB))
private serviceB: ServiceB
```

### 3. 数据库连接问题
```bash
# 检查数据库连接
npm run typeorm:check

# 重新生成数据库
npm run db:drop
npm run db:create
npm run migration:run
```

### 4. 缓存问题
```bash
# 清理npm缓存
npm cache clean --force

# 重新安装依赖
rm -rf node_modules package-lock.json
npm install
```

---

## 📚 相关文档链接

- 📖 [后端API文档](./后端API文档.md)
- 🏗️ [后端模块架构文档](./后端模块架构文档.md)
- 📋 [API变更说明](./API变更说明.md)
- 🗄️ [数据库设计文档](./数据库设计文档.md)
- 🔒 [JWT认证技术文档](./JWT认证技术文档.md)
- 🚀 [部署和配置文档](./部署和配置文档.md)

---

## 💡 最佳实践提醒

1. **代码规范**: 遵循ESLint和Prettier配置
2. **类型安全**: 充分利用TypeScript类型系统
3. **错误处理**: 使用统一的异常过滤器
4. **日志记录**: 合理使用Logger记录关键操作
5. **安全防护**: 始终验证用户输入和权限
6. **性能优化**: 合理使用缓存和数据库索引
7. **测试覆盖**: 为关键业务逻辑编写测试
8. **文档更新**: 及时更新API文档和注释

---

*本参考文档将随着项目发展持续更新，建议收藏备用。*
